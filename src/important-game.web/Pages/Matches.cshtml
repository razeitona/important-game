@page
@using System.Globalization
@using System.Text.Json
@using important_game.infrastructure.Extensions
@model MatchesModel
@{
    ViewData["Title"] = "Upcoming Exciting Football Matches - Browse by Excitement Score";
    ViewData["Description"] = "Browse all upcoming football matches sorted by excitement score. Filter by competition, teams, and find the most thrilling games to watch across all major leagues.";
    ViewData["Keywords"] = "upcoming football matches, football fixtures, match excitement scores, football schedule, premier league, la liga, champions league";
}

<div class="wm-match-filter">
    <div class="input-group mw-search">
        <i class="bi bi-search"></i>
        <input type="text" class="form-control" placeholder="Search match or team..." id="search-match">
        <ul id="mw-search-result"></ul>
    </div>
    <div class="filter-actions">
        <button id="clearFiltersBtn" class="btn-clear-filters" style="display: none;">
            <i class="bi bi-x-circle"></i>
            <span>Clear Filters</span>
        </button>
        <a href="/calendar" class="btn-calendar-toggle" title="View Calendar">
            <i class="bi bi-calendar3"></i>
            <span>Calendar View</span>
        </a>
    </div>
</div>


<div class="wm-matches">


    <div class="match-league-filter">
        @foreach (var competition in Model.Matches.Competitions)
        {
            <div class="match-league-item" data-league="@competition.CompetitionId">
                <img src="@("images/competition/" + competition.CompetitionId + ".png")" alt="@competition.Name" width="20px" />
                <span>@competition.Name</span>
            </div>
        }
    </div>

    <div class="matches-section" id="all-matches-section">
        @* Skeleton loading state (hidden by default, shown during filter/search) *@
        <div class="skeleton-match-list skeleton-content" style="display: none;">
            @for (int d = 0; d < 3; d++)
            {
                <div class="skeleton skeleton-date-header"></div>
                <div class="skeleton-matches-grid">
                    @for (int i = 0; i < 6; i++)
                    {
                        <partial name="_SkeletonMatchCardSimple" />
                    }
                </div>
            }
        </div>

        @* Actual content *@
        <div class="actual-content">
            @if (Model.Matches.Matches.Count == 0)
            {
                <label>No excitment match to watch this week. We are looking for one.</label>
            }
            else
            {
                @foreach (var dates in Model.Matches.Matches.GroupBy(c => c.MatchDateUTC.Date))
                {
                    <div class="wm-match-date">
                        <h1 class="wm-match-date-title">
                            <time data-utc-time="@dates.Key.ToString("dd/MM/yyyy")">
                                @dates.Key.ToString("dd/MM/yyyy")
                            </time>
                        </h1>
                        <div class="matches-section-content">
                            @foreach (var match in dates.OrderByDescending(c => c.ExcitmentScore))
                            {
                                <partial name="_MatchCardSimple" for="@match" />
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

    <script>




        $(document).ready(function () {

            var list = @Html.Raw(JsonSerializer.Serialize(
                                    Model.Matches.Matches.Select(c =>
                                        new {
                                            id = c.MatchId,
                                            home = c.HomeTeamName,
                                            away = c.AwayTeamName,
                                            homeslug = SlugHelper.GenerateSlug(c.HomeTeamName),
                                            awayslug = SlugHelper.GenerateSlug(c.AwayTeamName)
                                        })));

            // Initialize filter state
            var filterLeagues = [];

            // URL Parameters Filter Persistence
            const urlParams = new URLSearchParams(window.location.search);

            function updateURLParams() {
                const url = new URL(window.location);

                // Update leagues parameter
                if (filterLeagues.length > 0) {
                    url.searchParams.set('leagues', filterLeagues.join(','));
                } else {
                    url.searchParams.delete('leagues');
                }

                // Update search parameter
                const searchValue = searchInput ? searchInput.value : '';
                if (searchValue && searchValue.length >= 3) {
                    url.searchParams.set('search', searchValue);
                } else {
                    url.searchParams.delete('search');
                }

                // Update URL without reload
                window.history.pushState({}, '', url);
            }

            function loadFiltersFromURL() {
                // Load league filters
                const leaguesParam = urlParams.get('leagues');
                if (leaguesParam) {
                    const savedLeagues = leaguesParam.split(',').map(id => parseInt(id)).filter(id => !isNaN(id));
                    filterLeagues = savedLeagues;

                    // Apply visual state to league buttons
                    savedLeagues.forEach(leagueId => {
                        $(`.match-league-item[data-league="${leagueId}"]`).addClass('league-active');
                    });
                }

                // Load search filter
                const searchParam = urlParams.get('search');
                if (searchParam && searchInput) {
                    searchInput.value = searchParam;
                    // Trigger search
                    const results = fuse.search(searchParam);
                    updateSearchResults(results, searchParam);
                }

                // Apply filters to matches
                if (filterLeagues.length > 0) {
                    updateGameHideStatus();
                }

                // Update clear button visibility
                updateClearButtonVisibility();
            }

        const fuseOptions = {
        threshold: 0.3,           // Adjust to control the fuzzy matching
        minMatchCharLength: 3,     // Minimum length of the pattern to start matching
        keys: [
            "home",
            "away"
        ]
    };

            const fuse = new Fuse(list, fuseOptions);

            // Clear Filters functionality
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const searchInput = document.getElementById('search-match');

            function updateClearButtonVisibility() {
                const hasActiveFilters = filterLeagues.length > 0 || (searchInput && searchInput.value.length > 0);

                if (hasActiveFilters) {
                    clearFiltersBtn.style.display = 'flex';
                    clearFiltersBtn.classList.add('show');
                } else {
                    clearFiltersBtn.style.display = 'none';
                    clearFiltersBtn.classList.remove('show');
                }
            }

            clearFiltersBtn.addEventListener('click', function() {
                // Clear search input
                if (searchInput) {
                    searchInput.value = '';
                    document.getElementById('mw-search-result').innerHTML = '';
                }

                // Clear all league filters
                filterLeagues = [];
                $('.match-league-item').removeClass('league-active');

                // Show all matches
                updateGameHideStatus();

                // Clear URL parameters
                updateURLParams();

                // Hide clear button
                updateClearButtonVisibility();

                // Optional: Show notification
                if (window.timezoneManager) {
                    window.timezoneManager.showNotification('All filters cleared');
                }
            });

            // Search functionality with improved UX
            let selectedIndex = -1;
            const resultsList = document.getElementById('mw-search-result');

            function highlightMatch(text, query) {
                if (!query) return text;
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<strong>$1</strong>');
            }

            function updateSearchResults(results, query) {
                resultsList.innerHTML = '';
                selectedIndex = -1;

                if (results.length === 0) {
                    const noResults = document.createElement('li');
                    noResults.className = 'search-no-results';
                    noResults.innerHTML = `<i class="bi bi-search"></i> No matches found for "${query}"`;
                    resultsList.appendChild(noResults);
                    return;
                }

                results.forEach((result, index) => {
                    const game = result.item;
                    const li = document.createElement('li');
                    li.setAttribute('data-id', game.id);
                    li.setAttribute('data-index', index);
                    li.innerHTML = highlightMatch(`<span>${game.home} v ${game.away}</span>`, query);

                    // Add click event to navigate to the item
                    li.addEventListener('click', () => {
                        navigateToMatch(game);
                    });

                    resultsList.appendChild(li);
                });
            }

            function navigateToMatch(game) {
                window.location.href = `#game-${game.homeslug}v${game.awayslug}`;
                resultsList.innerHTML = '';
                searchInput.value = '';
                updateClearButtonVisibility();
            }

            function selectResult(index) {
                const items = resultsList.querySelectorAll('li:not(.search-no-results)');

                // Remove previous selection
                items.forEach(item => item.classList.remove('selected'));

                // Add selection to new item
                if (index >= 0 && index < items.length) {
                    selectedIndex = index;
                    items[index].classList.add('selected');
                    items[index].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }

            // Input event - search as user types
            searchInput.addEventListener('input', function () {
                const query = this.value;

                // Update clear button visibility
                updateClearButtonVisibility();

                // Update URL parameters
                updateURLParams();

                if (query.length < 3) {
                    resultsList.innerHTML = '';
                    selectedIndex = -1;
                    return;
                }

                // Perform search
                const results = fuse.search(query);
                updateSearchResults(results, query);
            });

            // Keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const items = resultsList.querySelectorAll('li:not(.search-no-results)');

                if (items.length === 0) return;

                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectResult(selectedIndex + 1 >= items.length ? 0 : selectedIndex + 1);
                        break;

                    case 'ArrowUp':
                        e.preventDefault();
                        selectResult(selectedIndex - 1 < 0 ? items.length - 1 : selectedIndex - 1);
                        break;

                    case 'Enter':
                        e.preventDefault();
                        if (selectedIndex >= 0 && selectedIndex < items.length) {
                            const selectedItem = items[selectedIndex];
                            const gameId = selectedItem.getAttribute('data-id');
                            const game = list.find(g => g.id == gameId);
                            if (game) {
                                navigateToMatch(game);
                            }
                        } else if (items.length > 0) {
                            // If no selection, select first result
                            const gameId = items[0].getAttribute('data-id');
                            const game = list.find(g => g.id == gameId);
                            if (game) {
                                navigateToMatch(game);
                            }
                        }
                        break;

                    case 'Escape':
                        e.preventDefault();
                        resultsList.innerHTML = '';
                        searchInput.blur();
                        selectedIndex = -1;
                        break;
                }
            });

            // Close results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsList.contains(e.target)) {
                    resultsList.innerHTML = '';
                    selectedIndex = -1;
                }
            });

            $(".match-league-item").each(function (elem) {
                if ($(this).hasClass("league-active")) {
                    var selectedDate = $(this).data("league");
                    updateGameHideStatus(selectedDate);
                    return;
                }
            });

            $(".match-league-item").on("click", function () {
                var selectedLeague = $(this).data("league");

                if (filterLeagues.indexOf(selectedLeague) == -1) {
                    filterLeagues.push(selectedLeague);
                    $(this).addClass("league-active");
                } else {
                    const index = filterLeagues.indexOf(selectedLeague);
                    filterLeagues.splice(index, 1);
                    $(this).removeClass("league-active");
                }
                updateGameHideStatus();

                // Update URL parameters
                updateURLParams();

                // Update clear button visibility
                updateClearButtonVisibility();
            });

            function updateGameHideStatus() {
                $(".match-card-simple").each(function (idx, elem) {
                    if (filterLeagues.length == 0) {
                        $(elem).removeClass("hide");
                    } else {
                        var matchLeague = $(elem).data("game-league");

                        if (filterLeagues.indexOf(matchLeague) > -1) {
                            $(elem).removeClass("hide");
                        } else {
                            $(elem).addClass("hide");
                        }
                    }
                });
            }

            $(".wm-match-date-title").on("click", function () {
                if ($(this).parent().children("div.matches-section-content").hasClass("hide")) {
                    $(this).removeClass("collapsed");
                    $(this).parent().children("div.matches-section-content").removeClass("hide");
                } else {
                    $(this).addClass("collapsed");
                    $(this).parent().children("div.matches-section-content").addClass("hide");
                }
            });

            // Load filters from URL on page load
            loadFiltersFromURL();

        });

    </script>
}