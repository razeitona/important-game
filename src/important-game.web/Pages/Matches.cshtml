@page
@using System.Globalization
@using System.Text.Json
@using important_game.infrastructure.Extensions
@model MatchesModel
@{
    ViewData["Title"] = "Upcoming Exciting Football Matches - Browse by Excitement Score";
    ViewData["Description"] = "Browse all upcoming football matches sorted by excitement score. Filter by competition, teams, and find the most thrilling games to watch across all major leagues.";
    ViewData["Keywords"] = "upcoming football matches, football fixtures, match excitement scores, football schedule, premier league, la liga, champions league";
}

@* Top Ad - Above Filters *@
<div class="ad-container ad-top-banner">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1934500034472565"
         data-ad-slot="3310130902"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>

@* Smart Filters Bar *@
<div class="smart-filters-bar">
    <div class="filter-section filter-excitment">
        <label class="filter-label" id="es-tier-label">
            <i class="bi bi-fire"></i>
            Excitement:
        </label>
        <div class="es-tier-filters" role="group" aria-labelledby="es-tier-label">
            <button class="es-tier-badge tier-unmissable" data-tier="unmissable" data-min="70" aria-label="Filter by Unmissable matches (ES 70+)">
                <span class="tier-name">Unmissable</span>
                <span class="tier-count">(0)</span>
            </button>
            <button class="es-tier-badge tier-great" data-tier="great" data-min="50" data-max="69" aria-label="Filter by Great matches (ES 50-69)">
                <span class="tier-name">Highly Exciting</span>
                <span class="tier-count">(0)</span>
            </button>
            <button class="es-tier-badge tier-good" data-tier="good" data-min="25" data-max="49" aria-label="Filter by Good matches (ES 25-49)">
                <span class="tier-name">Decent Watch</span>
                <span class="tier-count">(0)</span>
            </button>
            <button class="es-tier-badge tier-decent" data-tier="decent" data-min="0" data-max="24" aria-label="Filter by Good matches (ES 25-24)">
                <span class="tier-name">Decent</span>
                <span class="tier-count">(0)</span>
            </button>
        </div>
    </div>

    <div class="filter-section">
        <label class="filter-label" for="sortDropdown">
            <i class="bi bi-sort-down"></i>
            Sort by:
        </label>
        <select id="sortDropdown" class="sort-dropdown" aria-label="Sort matches by">
            <option value="es-desc">ES Score (High to Low)</option>
            <option value="es-asc">ES Score (Low to High)</option>
            <option value="date-asc">Date (Earliest First)</option>
            <option value="date-desc">Date (Latest First)</option>
        </select>
    </div>

    <div class="filter-section quick-presets-section">
        <label class="filter-label" id="presets-label">
            <i class="bi bi-lightning"></i>
            Quick:
        </label>
        <div class="quick-presets" role="group" aria-labelledby="presets-label">
            <button class="preset-btn" data-preset="today" aria-label="Show today's matches">
                <i class="bi bi-calendar-day"></i>
                <span>Today</span>
            </button>
            <button class="preset-btn" data-preset="weekend" aria-label="Show weekend matches">
                <i class="bi bi-calendar-week"></i>
                <span>Weekend</span>
            </button>
            <button class="preset-btn" data-preset="top" aria-label="Show top matches">
                <i class="bi bi-star-fill"></i>
                <span>Top Matches</span>
            </button>
        </div>
    </div>
</div>

<div class="wm-match-filter">
    <div class="input-group mw-search">
        <i class="bi bi-search"></i>
        <input type="text" class="form-control" placeholder="Search match or team..." id="search-match">
        <ul id="mw-search-result"></ul>
    </div>
    <div class="filter-actions">
        <button id="clearFiltersBtn" class="btn-clear-filters" style="display: none;">
            <i class="bi bi-x-circle"></i>
            <span>Clear Filters</span>
        </button>
        <a href="/calendar" class="btn-calendar-toggle" title="View Calendar">
            <i class="bi bi-calendar3"></i>
            <span>Calendar View</span>
        </a>
    </div>
</div>


<div class="wm-matches">


    <div class="match-league-filter">
        @foreach (var competition in Model.Matches.Competitions)
        {
            <div class="match-league-item" data-league="@competition.CompetitionId">
                <img src="@("images/competition/" + competition.CompetitionId + ".webp")" alt="@competition.Name" width="20px" />
                <span>@competition.Name</span>
            </div>
        }
    </div>

    <div class="matches-section" id="all-matches-section">
        @* Skeleton loading state (hidden by default, shown during filter/search) *@
        <div class="skeleton-match-list skeleton-content" style="display: none;">
            @for (int d = 0; d < 3; d++)
            {
                <div class="skeleton skeleton-date-header"></div>
                <div class="skeleton-matches-grid">
                    @for (int i = 0; i < 6; i++)
                    {
                        <partial name="_SkeletonMatchCardSimple" />
                    }
                </div>
            }
        </div>

        @* Actual content *@
        <div class="actual-content">
            @if (Model.Matches.Matches.Count == 0)
            {
                <label>No excitment match to watch this week. We are looking for one.</label>
            }
            else
            {
                @foreach (var dates in Model.Matches.Matches.GroupBy(c => c.MatchDateUTC.Date))
                {
                    <div class="wm-match-date">
                        <h1 class="wm-match-date-title">
                            <time data-utc-time="@dates.Key.ToString("dd/MM/yyyy")">
                                @dates.Key.ToString("dd/MM/yyyy")
                            </time>
                        </h1>
                        <div class="matches-section-content">
                            @foreach (var match in dates.OrderByDescending(c => c.ExcitmentScore))
                            {
                                <partial name="_MatchCardSimple" for="@match" />
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

    <script>




        $(document).ready(function () {

            var list = @Html.Raw(JsonSerializer.Serialize(
                                    Model.Matches.Matches.Select(c =>
                                        new {
                                            id = c.MatchId,
                                            home = c.HomeTeamName,
                                            away = c.AwayTeamName,
                                            homeslug = SlugHelper.GenerateSlug(c.HomeTeamName),
                                            awayslug = SlugHelper.GenerateSlug(c.AwayTeamName),
                                            es = c.ExcitmentScore,
                                            date = c.MatchDateUTC,
                                            league = c.CompetitionId
                                        })));

            // Initialize filter state
            var filterLeagues = [];
            var filterESTier = null; // 'unmissable', 'great', 'good', or null
            var currentSort = 'es-desc'; // Default sort
            var activePreset = null;

            // URL Parameters Filter Persistence
            const urlParams = new URLSearchParams(window.location.search);

            function updateURLParams() {
                const url = new URL(window.location);

                // Update leagues parameter
                if (filterLeagues.length > 0) {
                    url.searchParams.set('leagues', filterLeagues.join(','));
                } else {
                    url.searchParams.delete('leagues');
                }

                // Update ES tier parameter
                if (filterESTier) {
                    url.searchParams.set('tier', filterESTier);
                } else {
                    url.searchParams.delete('tier');
                }

                // Update sort parameter
                if (currentSort !== 'es-desc') {
                    url.searchParams.set('sort', currentSort);
                } else {
                    url.searchParams.delete('sort');
                }

                // Update search parameter
                const searchValue = searchInput ? searchInput.value : '';
                if (searchValue && searchValue.length >= 3) {
                    url.searchParams.set('search', searchValue);
                } else {
                    url.searchParams.delete('search');
                }

                // Update URL without reload
                window.history.pushState({}, '', url);
            }

            // Calculate and update ES tier badge counts
            function updateESTierCounts() {
                const unmissableCount = $('.match-card-simple').filter(function() {
                    const es = parseFloat($(this).data('game-score'));
                    return es >= 70;
                }).length;

                const greatCount = $('.match-card-simple').filter(function() {
                    const es = parseFloat($(this).data('game-score'));
                    return es >= 50 && es < 70;
                }).length;

                const goodCount = $('.match-card-simple').filter(function() {
                    const es = parseFloat($(this).data('game-score'));
                    return es >= 25 && es < 50;
                }).length;

                const decentCount = $('.match-card-simple').filter(function() {
                    const es = parseFloat($(this).data('game-score'));
                    return es < 25;
                }).length;

                $('.es-tier-badge[data-tier="unmissable"] .tier-count').text(`(${unmissableCount})`);
                $('.es-tier-badge[data-tier="great"] .tier-count').text(`(${greatCount})`);
                $('.es-tier-badge[data-tier="good"] .tier-count').text(`(${goodCount})`);
                $('.es-tier-badge[data-tier="decent"] .tier-count').text(`(${decentCount})`);
            }

            // Apply sorting to matches
            function applySorting() {
                const $dates = $('.wm-match-date');

                $dates.each(function() {
                    const $content = $(this).find('.matches-section-content');
                    const $cards = $content.find('.match-card-simple:visible');

                    const cardsArray = $cards.toArray();

                    cardsArray.sort(function(a, b) {
                        const aES = parseFloat($(a).data('game-score'));
                        const bES = parseFloat($(b).data('game-score'));
                        const aDate = new Date($(a).data('game-date'));
                        const bDate = new Date($(b).data('game-date'));

                        switch(currentSort) {
                            case 'es-desc':
                                return bES - aES;
                            case 'es-asc':
                                return aES - bES;
                            case 'date-asc':
                                return aDate - bDate;
                            case 'date-desc':
                                return bDate - aDate;
                            default:
                                return bES - aES;
                        }
                    });

                    // Reorder DOM elements
                    $content.append(cardsArray);
                });
            }

            function loadFiltersFromURL() {
                // Load league filters
                const leaguesParam = urlParams.get('leagues');
                if (leaguesParam) {
                    const savedLeagues = leaguesParam.split(',').map(id => parseInt(id)).filter(id => !isNaN(id));
                    filterLeagues = savedLeagues;

                    // Apply visual state to league buttons
                    savedLeagues.forEach(leagueId => {
                        $(`.match-league-item[data-league="${leagueId}"]`).addClass('league-active');
                    });
                }

                // Load ES tier filter
                const tierParam = urlParams.get('tier');
                if (tierParam && ['unmissable', 'great', 'good', 'decent'].includes(tierParam)) {
                    filterESTier = tierParam;
                    $(`.es-tier-badge[data-tier="${tierParam}"]`).addClass('active');
                }

                // Load sort option
                const sortParam = urlParams.get('sort');
                if (sortParam) {
                    currentSort = sortParam;
                    $('#sortDropdown').val(sortParam);
                }

                // Load search filter
                const searchParam = urlParams.get('search');
                if (searchParam && searchInput) {
                    searchInput.value = searchParam;
                    // Trigger search
                    const results = fuse.search(searchParam);
                    updateSearchResults(results, searchParam);
                }

                // Apply filters to matches
                if (filterLeagues.length > 0 || filterESTier) {
                    updateGameHideStatus();
                }

                // Apply sorting
                applySorting();

                // Update clear button visibility
                updateClearButtonVisibility();
            }

        const fuseOptions = {
        threshold: 0.3,           // Adjust to control the fuzzy matching
        minMatchCharLength: 3,     // Minimum length of the pattern to start matching
        keys: [
            "home",
            "away"
        ]
    };

            const fuse = new Fuse(list, fuseOptions);

            // Clear Filters functionality
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const searchInput = document.getElementById('search-match');

            function updateClearButtonVisibility() {
                const hasActiveFilters = filterLeagues.length > 0 ||
                                        filterESTier !== null ||
                                        currentSort !== 'es-desc' ||
                                        activePreset !== null ||
                                        (searchInput && searchInput.value.length > 0);

                if (hasActiveFilters) {
                    clearFiltersBtn.style.display = 'flex';
                    clearFiltersBtn.classList.add('show');
                } else {
                    clearFiltersBtn.style.display = 'none';
                    clearFiltersBtn.classList.remove('show');
                }
            }

            clearFiltersBtn.addEventListener('click', function() {
                // Clear search input
                if (searchInput) {
                    searchInput.value = '';
                    document.getElementById('mw-search-result').innerHTML = '';
                }

                // Clear all league filters
                filterLeagues = [];
                $('.match-league-item').removeClass('league-active');

                // Clear ES tier filter
                filterESTier = null;
                $('.es-tier-badge').removeClass('active');

                // Reset sort to default
                currentSort = 'es-desc';
                $('#sortDropdown').val('es-desc');

                // Clear preset
                activePreset = null;
                $('.preset-btn').removeClass('active');

                // Show all date sections
                $('.wm-match-date').show();

                // Show all matches
                updateGameHideStatus();

                // Apply default sorting
                applySorting();

                // Clear URL parameters
                updateURLParams();

                // Hide clear button
                updateClearButtonVisibility();

                // Optional: Show notification
                if (window.timezoneManager) {
                    window.timezoneManager.showNotification('All filters cleared');
                }
            });

            // Search functionality with improved UX
            let selectedIndex = -1;
            const resultsList = document.getElementById('mw-search-result');

            function highlightMatch(text, query) {
                if (!query) return text;
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<strong>$1</strong>');
            }

            function updateSearchResults(results, query) {
                resultsList.innerHTML = '';
                selectedIndex = -1;

                if (results.length === 0) {
                    const noResults = document.createElement('li');
                    noResults.className = 'search-no-results';
                    noResults.innerHTML = `<i class="bi bi-search"></i> No matches found for "${query}"`;
                    resultsList.appendChild(noResults);
                    return;
                }

                results.forEach((result, index) => {
                    const game = result.item;
                    const li = document.createElement('li');
                    li.setAttribute('data-id', game.id);
                    li.setAttribute('data-index', index);
                    li.innerHTML = highlightMatch(`<span>${game.home} v ${game.away}</span>`, query);

                    // Add click event to navigate to the item
                    li.addEventListener('click', () => {
                        navigateToMatch(game);
                    });

                    resultsList.appendChild(li);
                });
            }

            function navigateToMatch(game) {
                window.location.href = `#game-${game.homeslug}v${game.awayslug}`;
                resultsList.innerHTML = '';
                searchInput.value = '';
                updateClearButtonVisibility();
            }

            function selectResult(index) {
                const items = resultsList.querySelectorAll('li:not(.search-no-results)');

                // Remove previous selection
                items.forEach(item => item.classList.remove('selected'));

                // Add selection to new item
                if (index >= 0 && index < items.length) {
                    selectedIndex = index;
                    items[index].classList.add('selected');
                    items[index].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }

            // Input event - search as user types
            searchInput.addEventListener('input', function () {
                const query = this.value;

                // Update clear button visibility
                updateClearButtonVisibility();

                // Update URL parameters
                updateURLParams();

                if (query.length < 3) {
                    resultsList.innerHTML = '';
                    selectedIndex = -1;
                    return;
                }

                // Perform search
                const results = fuse.search(query);
                updateSearchResults(results, query);
            });

            // Keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const items = resultsList.querySelectorAll('li:not(.search-no-results)');

                if (items.length === 0) return;

                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectResult(selectedIndex + 1 >= items.length ? 0 : selectedIndex + 1);
                        break;

                    case 'ArrowUp':
                        e.preventDefault();
                        selectResult(selectedIndex - 1 < 0 ? items.length - 1 : selectedIndex - 1);
                        break;

                    case 'Enter':
                        e.preventDefault();
                        if (selectedIndex >= 0 && selectedIndex < items.length) {
                            const selectedItem = items[selectedIndex];
                            const gameId = selectedItem.getAttribute('data-id');
                            const game = list.find(g => g.id == gameId);
                            if (game) {
                                navigateToMatch(game);
                            }
                        } else if (items.length > 0) {
                            // If no selection, select first result
                            const gameId = items[0].getAttribute('data-id');
                            const game = list.find(g => g.id == gameId);
                            if (game) {
                                navigateToMatch(game);
                            }
                        }
                        break;

                    case 'Escape':
                        e.preventDefault();
                        resultsList.innerHTML = '';
                        searchInput.blur();
                        selectedIndex = -1;
                        break;
                }
            });

            // Close results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsList.contains(e.target)) {
                    resultsList.innerHTML = '';
                    selectedIndex = -1;
                }
            });

            $(".match-league-item").each(function (elem) {
                if ($(this).hasClass("league-active")) {
                    var selectedDate = $(this).data("league");
                    updateGameHideStatus(selectedDate);
                    return;
                }
            });

            $(".match-league-item").on("click", function () {
                var selectedLeague = $(this).data("league");

                if (filterLeagues.indexOf(selectedLeague) == -1) {
                    filterLeagues.push(selectedLeague);
                    $(this).addClass("league-active");
                } else {
                    const index = filterLeagues.indexOf(selectedLeague);
                    filterLeagues.splice(index, 1);
                    $(this).removeClass("league-active");
                }
                updateGameHideStatus();

                // Update URL parameters
                updateURLParams();

                // Update clear button visibility
                updateClearButtonVisibility();
            });

            function updateGameHideStatus() {
                $(".match-card-simple").each(function (idx, elem) {
                    let show = true;

                    // Filter by league
                    if (filterLeagues.length > 0) {
                        var matchLeague = $(elem).data("game-league");
                        if (filterLeagues.indexOf(matchLeague) === -1) {
                            show = false;
                        }
                    }

                    // Filter by ES tier
                    if (show && filterESTier !== null) {
                        const esScore = parseFloat($(elem).data("game-score"));
                        const $tierBadge = $(`.es-tier-badge[data-tier="${filterESTier}"]`);
                        const minES = parseInt($tierBadge.data('min'));
                        const maxES = $tierBadge.data('max') ? parseInt($tierBadge.data('max')) : 100;

                        if (esScore < minES || esScore > maxES) {
                            show = false;
                        }
                    }

                    // Show or hide based on filters
                    if (show) {
                        $(elem).removeClass("hide");
                    } else {
                        $(elem).addClass("hide");
                    }
                });

                // Hide date sections with no visible matches
                $('.wm-match-date').each(function() {
                    const visibleMatches = $(this).find('.match-card-simple:not(.hide)').length;
                    if (visibleMatches === 0) {
                        $(this).hide();
                    } else {
                        $(this).show();
                    }
                });

                // Apply sorting after filtering
                applySorting();

                // Update ES tier counts
                updateESTierCounts();
            }

            $(".wm-match-date-title").on("click", function () {
                if ($(this).parent().children("div.matches-section-content").hasClass("hide")) {
                    $(this).removeClass("collapsed");
                    $(this).parent().children("div.matches-section-content").removeClass("hide");
                } else {
                    $(this).addClass("collapsed");
                    $(this).parent().children("div.matches-section-content").addClass("hide");
                }
            });

            // ES Tier filter handlers
            $('.es-tier-badge').on('click', function() {
                const tier = $(this).data('tier');

                if (filterESTier === tier) {
                    // Deactivate if clicking the same tier
                    filterESTier = null;
                    $(this).removeClass('active');
                } else {
                    // Activate new tier
                    filterESTier = tier;
                    $('.es-tier-badge').removeClass('active');
                    $(this).addClass('active');
                }

                updateGameHideStatus();
                updateURLParams();
                updateClearButtonVisibility();
            });

            // Sort dropdown handler
            $('#sortDropdown').on('change', function() {
                currentSort = $(this).val();
                applySorting();
                updateURLParams();
                updateClearButtonVisibility();
            });

            // Quick preset handlers
            $('.preset-btn').on('click', function() {
                const preset = $(this).data('preset');
                const now = new Date();

                // Clear previous preset selection
                $('.preset-btn').removeClass('active');

                if (activePreset === preset) {
                    // Deactivate if clicking the same preset
                    activePreset = null;
                    // Show all matches
                    $('.wm-match-date').show();
                } else {
                    // Activate new preset
                    activePreset = preset;
                    $(this).addClass('active');

                    // Apply preset logic
                    if (preset === 'today') {
                        // Show only today's matches
                        $('.wm-match-date').each(function() {
                            const dateText = $(this).find('.wm-match-date-title time').data('utc-time');
                            const matchDate = new Date(dateText.split('/').reverse().join('-'));
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            const dateOnly = new Date(matchDate.getFullYear(), matchDate.getMonth(), matchDate.getDate());

                            if (dateOnly.getTime() === today.getTime()) {
                                $(this).show();
                            } else {
                                $(this).hide();
                            }
                        });
                    } else if (preset === 'weekend') {
                        // Show weekend matches (Saturday and Sunday)
                        $('.wm-match-date').each(function() {
                            const dateText = $(this).find('.wm-match-date-title time').data('utc-time');
                            const matchDate = new Date(dateText.split('/').reverse().join('-'));
                            const dayOfWeek = matchDate.getDay();
                            const matchDateOnly = new Date(matchDate.getFullYear(), matchDate.getMonth(), matchDate.getDate());

                            // Determine the upcoming weekend
                            let targetSaturday, targetSunday;
                            const currentDay = now.getDay(); // 0=Sunday, 6=Saturday

                            if (currentDay === 6) {
                                // Today is Saturday - show this weekend
                                targetSaturday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                targetSunday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                            } else if (currentDay === 0) {
                                // Today is Sunday - show this weekend
                                targetSaturday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                                targetSunday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            } else {
                                // Weekday - show next weekend
                                const daysUntilSaturday = 6 - currentDay;
                                targetSaturday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + daysUntilSaturday);
                                targetSunday = new Date(targetSaturday.getFullYear(), targetSaturday.getMonth(), targetSaturday.getDate() + 1);
                            }

                            if (matchDateOnly.getTime() === targetSaturday.getTime() || matchDateOnly.getTime() === targetSunday.getTime()) {
                                $(this).show();
                            } else {
                                $(this).hide();
                            }
                        });
                    } else if (preset === 'top') {
                        // Filter by ES > 70 and show all dates with such matches
                        filterESTier = 'unmissable';
                        $('.es-tier-badge').removeClass('active');
                        $('.es-tier-badge[data-tier="unmissable"]').addClass('active');
                        updateGameHideStatus();
                    }
                }

                updateURLParams();
                updateClearButtonVisibility();
            });

            // Initialize ES tier counts on page load
            updateESTierCounts();

            // Load filters from URL on page load
            loadFiltersFromURL();

        });

    </script>
}